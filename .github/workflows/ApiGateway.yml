name: ApiGateway Pipeline

on:
  push:
    paths:
      - 'File-It/ApiGateway/**'
  pull_request:
    paths:
      - 'File-It/ApiGateway/**'
  workflow_dispatch: 

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        dotnet-version: [8.0.x]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ matrix.dotnet-version }}

    - name: Restore dependencies
      run: dotnet restore File-It/ApiGateway/ApiGateway.csproj


    # BUILDING
    - name: Build
      run: dotnet build --no-restore --configuration Release File-It/ApiGateway/ApiGateway.csproj

    #- name: Test
    # run: dotnet test --no-restore --verbosity normal --configuration Release File-It/ApiGateway/ApiGateway.csproj

    - name: Publish
      run: dotnet publish --no-restore --configuration Release --output ./output File-It/ApiGateway/ApiGateway.csproj

      
    # # DOCKER IMAGE  
    # - name: Build Docker image
    #   run: docker build -t ${{ secrets.DOCKER_USERNAME }}/apigateway:latest -f File-It/ApiGateway/Dockerfile .

    # # DOCKER HUB
    # - name: Log in to Docker Hub
    #   run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    # - name: Push Docker image to Docker Hub
    #   run: docker push ${{ secrets.DOCKER_USERNAME }}/apigateway:latest

    # Minikube setup
    - name: Install Minikube
      run: |
        curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
        chmod +x minikube
        sudo mv minikube /usr/local/bin/

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Start Minikube
      run: minikube start --driver=docker

    - name: Use Minikube Docker daemon
      run: eval $(minikube -p minikube docker-env)

    - name: Build Docker image for Minikube
      run: docker build -t fileservice:latest -f File-It/FileServiceAPI/Dockerfile .
      
    - name: Deploy to Minikube
      run: |
        kubectl create deployment apigateway --image=apigateway:latest
        kubectl expose deployment apigateway --type=LoadBalancer --port=5000
    - name: debug
      run: kubectl get services
    
    - name: debug2
      run: kubectl get pods -A
    
    - name: debug3
      run: kubectl get events --sort-by=.metadata.creationTimestamp

    - name: debug4
      run: kubectl describe pod

    - name: Run Minikube Tunnel
      run: nohup minikube tunnel > /dev/null 2>&1 &

    - name: Get Minikube service URL
      run: minikube service apigateway --url       
